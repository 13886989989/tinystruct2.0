<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Small Talk</title>
<style type="text/css">
textarea {
	width:100%;height:20px
}
</style>
<script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="//ingod.asia/themes/scripts/timer.js"></script>
<script type="text/javascript">
//<![CDATA[
var timer = new Timer(.2,function(){});
var old_title = document.title;
function update($data) {
	if(typeof($data.message)!='undefined') {
	  $li = $("<li />");
	  $li.html($data.time + "\t" + $data.user + ": " + $data.message);
		$('#list').append($li);
		
    timer.setAction(function() {
       if(document.title == '') {
       	document.title = 'New Message(s) Received!';
       }
       else {
       	document.title = '';
       }
    });
	}
	else {
    $user = $data.user;
    document.title = $user + " is typing";
    timer.setAction(function() {
       document.title += '.';
    });
  }
	
	timer.start().complete(function(){ timer.start();});
}

function command(cmd){
  $.ajax({
    type: "POST",
    url: "[%LINK:talk/command%]",
    data: { cmd: cmd }
  }).done(function( msg ) {});
}

function save(){
	$.ajax({
		type: "POST",
		url: "[%LINK:talk/save%]",
		data: { text: $("#text").val() }
	}).done(function( msg ) {
		$("#text").val('');
	});
}

function autoupdate(){
	$.getJSON( "[%LINK:talk/update%]", function(data) {
		update(data);
	}).done(function() {
		autoupdate();
	}).error(function( msg ) {
		autoupdate();
	});
}

$(function(){
	$("#button").click(function(){
		save();
	});
	
	$("#text").keyup(function(event){
		if(event.which == 13) save();
		timer.stop(3);
	});
	
	$("#text").focus(function(event){
		command("kepress");
	});
	
	$("#sender").submit(function(event){
		event.preventDefault();
		save();
	});
	
	autoupdate();
});
//]]>
</script>
</head>
<body>
<ul id="list"><li>Welcome to use smalltalk application!</li></ul>
<form id="sender">
<textarea id="text" name="text"></textarea>
<input type="button" id="button" value="Send"/>
</form>
</body>
</html>
